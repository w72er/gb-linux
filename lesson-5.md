# Устройство файловой системы Linux. Понятия файла и каталога
## Домашнее задание 9:06


Если я знаю шаги которые нужно выполнить,
я могу достигнуть результат просто загуглив шаги.

Я использовал vim потому что круто, но nano имеет множество преимуществ.
Например, нет проблем с переходом между режимами редактируя русский текст. 

ctrlD - макрос, о завершение ввода файла.

## Универсальный доступ по ключу для любой ОС
```text
> ssh-keygen # generate key
# the scp is available for all modern OS.
# the public key must be copied, not private!
> scp gb_rsa.pub user@192.168.1.175
# after that operation the public key is apeared in user home directory
$ cat gb_rsa.pub > .ssh/authorized_keys
# if you don't have .ssh directory, just create it.
# now we cat disable auth by password
$ sudo nano /etc/ssh/sshd_config
# auth pass Yes -> No

ssh -i gb_rsa user@192.168.1.175 # -i какой ключ использовать.
```

На сервер обычно добавляется несколько публичных ключей разных пользователей
Однако, один пользователь может так же добавить несколько пользователей.

## План урока

1. Файловая система.
2. Понятия файла и каталога.
3. Типы файлов в Linux.
4. inode и каталог.
5. Права доступа к файлам и каталогам.

## Файловая система.

ФС организована в виде древовидной структуры, каталоги и вложенные каталоги
и файлы.

В UNIх* нет разделения по дискам и начинается FS с корня.
Другие разделы монтируются в папки.

## Понятия файла и каталога.

В линукс все файл.
* папка файл
* процессы общаются через файл
* устройства проецируются в файлы.

## Типы файлов в Linux.

* обычные
* каталоги - списки
* файлы физических устройств
** блочные - жесткие диски сиди ром, - что работает с данными. Передача данных блоками - так быстрее
** символьные - по символу, например, терминал
* именованные каналы - однонаправленное общение
* сокеты - двунаправленное общение
* символические ссылки.

## inode и каталог.

индексный дескриптор - структура в которой хранится вся информация о файле:
* владелец, права доступа, права, время последнего изменения
* информация о физическом расположении данный

Каталог соответствие имени файла и inode.
В одном каталоге не должно быть повторяющихся имен.
Но нет требования что разные имена могут ссылаться на 1 inode.

```text
ll /
tree # отображает содержимое в виде дерева
```

Символические ссылки - функционал ФС, с помощью которой мы можем указывать

Жесткая ссылка - запись в каталоге, указывающая на inode. Ссылается
только на файлы. Но есть две жесткие ссылки на каталоги ("." и "..").
Могут жесткие ссылки только на файлы того же раздела, поскольку 
таблицы inode свои у каждого раздела.

Символическая ссылка - это запись в каталоге, указывающая на имя
объекта с другим inode.

```text
ls -a
. # hard link
.. # hard link

echo 'some text' > file1.txt
# create hard link
ln file1.txt hlfile2.txt
# to understand difference of file1 and hlfile2, we compare their
# inodes
ls -il
# they have the same first column - inode.

echo 'some' > file3.txt
# create symlink
ln -s file3.txt slfile3.txt
ls -il 
# sym link is shown by slfile3 -> file3.txt

rm file1.txt
# пока в файловой системе есть хотя бы одна ссылка на inode
файл не будет удален. Количество ссылок (столбец 3) уменьшилось с
2х до 1.

Можем ли задать права разные права на две хард ссылки одного inode?
Вопрос не корректный, поскольку информация о правах хранится в inode,
который один.

rm file3
# видим что появились проблемы по красной ссылке.

На символические права мы так же не можем так же назначить права,
поскольку символическая ссылка использует права, описанные в файле
на который она ссылается.
```

## Права доступа к файлам и каталогам.

* "-" обычный файл
* "d" каталог
* "b" файл блочного устройства
* "c" файл символьного устройства
* "s" socket
* "p" pipe
* "l" - символическая ссылка.

Первая тройка - права для владельца, первое имя в `ls -l`.
Вторая для группы владельца
Права для всех остальных

### Права доступа к файлам и каталогам

read - открытие и чтение файла, просмотр содержимого каталога
write - изменить содержимое файла или создавать, удалять,
переименовывать объекты в каталоге
execute - запустить файл, войти в каталог
(получить список атрибутов для папки)

Есть другой способ задания прав - в восьмиричной системе.
0 - ---
7 - rwx

```text
touch test_permissions.txt
# chmod ugo+-=rwx test_permission - шаблон команды
chmod o+x test_permissions.txt
chmod o=rw test_permissions.txt # забрали право x и добавили rw

chmod ugo+x test.sh # chmod +x test.sh - эквивалент.
```

1:15:00

Где физически хранятся данные?
Когда мы создавали ссылку, мы не создавали новый файл. Мы создали
хард ссылку, то эти стали равноценными записями.
В папках - имена и inode
На диске хранятся данные, которые указываются в inode.

Как сделать что-то в численном представлении:
```text
chmod -rwx test_perm.sh
chmod o-w test_perm.sh # поскольку система не хочет чтобы
                         вы потеряли доступ к файлы оставляя w
chmod 764 test_perm.sh # определение прав в численном представлении
```

Специальные биты

Для раздельных групп отдельные права мы не можем выставить.
Проблема в том, что такой механизм прав был разработан в 70х
и на текущий момент устарели

Права меняются от имени рут?
Мы можем менять права к файлу в двух случаях:
* когда мы - владелец
* под sudo

!!!И честно говоря мне трудно представить, что такая смена может быть полезной.
Признает ошибки,
Коллеги

Есть три спец. бита.

SUID (set user ID upon execution) — установка ID пользователя во
время выполнения. Разрешает пользователям запускать файл на
исполнение с правами того пользователя, которому принадлежит данный
файл. SUID работает с файлами.
Некоторый пользователь запускает файл, то запускается процесс от
имени владельца файла, а не некоторого пользователя.
Если посмотрим на функцию смены пароля `passwd`. 
Пароль менять нужно каждому пользователю, но они не имеют доступа к
/etc/shadow.
```text
ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 68208 мая 28  2020 /usr/bin/passwd
где s - и есть suid bit
```

То есть программа password используется под рутом.

SGID (set group ID upon execution) — установка ID группы во время
выполнения, применяется преимущественно к каталогам. Этот атрибут
устанавливает идентификатор группы каталога, а не группы владельца,
который создал файл в этом каталоге.

Использовался для папок совместного доступа, но сейчас не актуален
так как git.

Sticky — дополнительный атрибут, который устанавливается для
каталогов. Файлы из каталога с таким битом может удалить только
владелец (пользователь, создавший этот файл).

использовался для совместного использования 

в убунте стоит подсистема работы с правами ACL

```text
setfacl - определять права в современном виде, по умолчанию в убунте
уже установлена по умолчанию.
```

```text
chmod u+s test_perm.sh
chmod g+s project/ # те файлы и папки которые будут созданы, получат
группу каталога project

mkdir temp # - общая директория
chmod +t temp/
```


2. В зависимости  от относительной или абсолютной ссылки при перемещении
она будет работать или нет.
   
4. set group id - special bit

5. Догадайтесь сами.

6. задание на права, а не на скрытые файлы с .