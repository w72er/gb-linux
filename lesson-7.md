# Управление пакетами и репозиториями. Основы сетевой безопасности.

## План урока
1.30
Репозитории и управление репозиториями.
Подключение репозиториев.
Управление пакетами.
Основы сетевой безопасности.

## Репозитории и управление репозиториями.

Работа с программами - это работа с пакетами, то есть единая сборка.
В пакете может быть библиотека и функциональная часть для 
нескольких программ.
Пакеты могут быть:
Локальные 
В интернете

по типу репозитории
стандартные - официально поддерживаемые убунтой например
дополнительныео - некоторые сторонние разработчики
неофициальные - поддерживаются сообществом, сами можем себе сделать такой.

Програмное обеспечиние
Есть большое количество сборок и ни один производитель не поддерживает
его все.
main - свободное ПО, официально поддерживается компанией Canonical,
они их протестировали и включили в свою сборку
restricted - хоть и можно использовать без оплаты, в основном это
драйвера устройств, они защищены патентами, то есть юридически.
Universe - официально не поддерживается Canonical, но поддерживается
сообществом
multiverse - проприетарное ПО не поддерживаемое компанией, то есть
оно ей даже не тестировалось. Те драйвера, которые не проверялись.

Официальные репозитории делятся на ветки:
$release - пакеты на момент выхода релиза
$release-security - пакеты безопасности
$elease-updates - стандартные обновления. Никогда не останавливается
разработка и эти обносления
backports - LTS, но есть и промежуточные версии в которые выкладываются
новые наработки, что бы пользователи с ними ознакомились, вот этот
репозиротий с ними
partner — репозиторий, содержащий ПО компаний-партнёров Canonical.

## Подключение репозиториев.

У нас в системе уже прописаны репозитории, которые уже поддерживаются
Canonical.

Есть два способа:
1. Редактировать `etc/apt/sources.list`
2. Команда `apt-add-repository`.

cat `etc/apt/sources.list`
deb - основной формат пакетов
url
focal - версия у нас focal cat
stable - 

всегда есть зазор по времени, когда компания выпускает новое ПО,
потом его собирают в пакет и выкладывают в репозиторий. Чтобы не
дожидаться официальной сборки от canonical, можно подключить репозиторий
например, nginx, чтобы установить последнюю версию.

`deb [arch=amd64] http:/nginx.org/pachages/ubuntu focal nginx`
в квадратных скобках дополнительные параметры. Строку выше мы берем из
официальной документации.

Следующим шагом мы добавляем ключ, чтобы проверить, что мы установили
оригинальную версию, а не подмененную.

`curl -fsSL https://:nginx?..key | sudo apt-key add -`
команда сверху так же взята из официальной документации.

```text
sudo apt-get update
sudo apt-get install nginx # обратите внимание что ngixn устанавлива
ется не из стандартного репозитория.
```

52^35



## Управление пакетами.

apt - менеджер управления пакетами, можем искать пакета, устанавливать
и удалять, обновлять ОС, подключать репозитории.

Способы управления пакетами:
* dpkg старая система, но она не умеет скачивать пакеты из сети.
* apt
* snap - более новый, имеет специфику в структуре пакета.

`apt` - самый популярный способ. и его предлагает система, если не
найден

```text
sudo apt search zip | grep '^zip'
sudo apt install zip
sudo apt remove zip
# если сложные удаляем сервисы с их конфигурациями и данными
sudo apt purge nginx
# как мы можем обновить систему в целом, то есть обновления всех
# пакетов системы
sudo apt update # resourses
sudo apt upgrade # самих пакетов
```

dpkg - работает с локальными пакетами и значит не может искать.
```text
# установить vim с dpkg
sudo dpkg -l # all installed packages
sudo dpkg -l | grep vim
rc - удален
ii - установлен
скачать можем с любого ресурса, где есть пакет с расширением deb
wget - скачает файл ссылку на которую мы передаем.
ls -l .. | grep apt # не выводить все файлы.
sudo dpkg -i vim_8.1.deb # бывыют случаи когда этот способ сложнее
потому что нужны зависимости и dpkg не умеет скачивать эти зависимости
Такие цепочки зависимостей может быть очень длинными.
Проблему зависимостей решают apt, snap
sudo dpkg -r vim
```

snap - самый новый. Его специфика в формате пакетов. В его пакеты,
помещены сразу все зависимости пакеты. Если мы ставим несколько
программ у которых несколько одинаковых зависимостей, то будет
дублироваться библиотеки. Но они легко переносимы. Снэп можно считать
альтернативой собственной сборки программы.

```text
sudo snap search zip
P7Zip # - Desctop
bzip
sudo snap install bzip # в стабильной ветке нет такого пакета,
sudo snap install --candidate bzip # а в ветке кандидат есть
sudo snap refresh bzip # обновление пакета
sudo snap remove bzip
sudo snap list # меньше чем у dpkg - это разные системы.
```

## Основы сетевой безопасности.

фильтр - модуль, который встроен в ядро, который создает правили.

как проходят сетевые пакеты в нашей системе. Разберем сетевое взаимодействие.

Пакеты ходят по цепочкам
Первая цепочка прерутинг
Если он не наш, то он попадаетв forward, иначе в инпут
Процесс как правило отвечает, этот пакет попадает в маршрутизацию
и далее в output.

С каждой цепочки связана таблица, которая говорить что сделать с
пакетом: удалить, изменить...
Если говорить о защите системы, то 
!iptables_packet_flow.png!

команды определяем с помощью iptalbes.
Построить целостный фильтр, который будет логической единицей.
Поэтому стоить записать команды в файл, и его исполнить
```shell
iptables -F # очистка всех имеющихся правил

# Действия по умолчанию, что будет с пакетом если он не попадает
# ни под одно правилу, описанному ниже.
# Мы видим, что пакеты удаляются. И это правильный подход к построению фильтра
# (безопасности): сначала все запрещаем, а затем разрешаем что нужно.
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

# Разрешаем обмен по локальной петле/ Разрешают взаимодействие
# по протоколу TCP/IP. Процессы могут взаимодействовать между собой

# -A добавить правило для цепочки инпут для интерфейса локалхост
# действие разрешено
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Разрешаем пакеты icmp (для обмена служебной информацией)
# Если мы не сможем пропускать эти пакеты, то протокол
# TCP/IP работать не будет.
iptables -A INPUT -p icmp -j ACCEPT
iptables -A OUTPUT -p icmp -j ACCEPT

# Разрешаем соединения с динамических портов
# ssh 22, http 80, но бывают системы которые отвечают отправляют
# свои ответы из специального диапазона динамических портов.
# Обратите внимание, что из этих портов только исходящий трафик.
iptables -A OUTPUT -p TCP -m tcp --sport 32768:61000 -j ACCEPT
iptables -A OUTPUT -p UDP -m udp --sport 32768:61000 -j ACCEPT

# Разрешить только те пакеты, которые мы запросили.
# Разрешаем все пакеты протоколов TCP, UDP,
# То есть пропускаем все пакеты, которые относятся к действующему соединению.
# То есть установить соединение с имеющейся системой нельзя, а вот передавать
# данные по имеющимся соединениям можно.
iptables -A INPUT -p TCP -m state --state ESTABLISHED<RELATED -j ACCEPT
iptables -A INPUT -p UDP -m state --state ESTABLISHED<RELATED -j ACCEPT


# Но если работаем как сервер SSH, следует разрешит и нужные порты
# Разрешаем проход пакетов с порта 22 и на порт 22
iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp -m tcp --sport 22 -j ACCEPT
```

Если выполните последние две команды,
```shell
# Но если работаем как сервер SSH, следует разрешит и нужные порты
# Разрешаем проход пакетов с порта 22 и на порт 22
iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp -m tcp --sport 22 -j ACCEPT
```
то вы ничего не настроите, поскольку и так все по умолчанию разрешено.

лайф хак, чтобы исключить хакерские атаки, можно запустить ssh не на 22
порту, тогда хакер, вынужден будет сканировать порты. Узнать проще всего
через администратора системы на каком порту

Теперь у нас есть скрипт, после этого все наши правила вступят в силу, но
после перезапуска системы эти правила пропадут. Чтобы эти правила всегда были
необходимо прописать эти правила в конфигурационных файлов. Это вне нашего
урока, поэтому не будем рассматривать.

```shell
sudo iptables-save # выводит все действующие правила на экран
# ??? вывод какой
sudo systemctl stop docker
sudo ./new_iptables
sudo iptables-save # Сейчас уже видим правила, которые создали мы
                   # немножко в другом виде, но вы разберетесь
sudo iptables-save > iptables.rules
sudo iptables-restore < iptables.rules
```

Практическое задание
1-2 задания необходимо отчитаться с помощью скриншота
3. на порт 22 мы рассмотрели, добавить разрешения на 80 порт, не забывайте, что должен входить в 
в весь фильтр. Смотри в примерах.
4. Проброс портов смотри в методичке, но все таки подумайте сами, не копируйте по методичке, т.к. это неполное решение.
   